# ri-event-log — API Reference

**Version**: 1.0.0  
**Phase**: 0 (IndexedDB / browser)  
**Tests**: 268 passed across 22 files  
**Coverage**: 94.68% lines · 86% branches · 98% functions

---

## §1 Identity

Append-only immutable event log with SHA-256 hash chain integrity, temporal queries, and tiered storage.

| Field | Value |
|-------|-------|
| Package | `ri-event-log` |
| Language | TypeScript (strict mode) |
| Runtime | Browser (IndexedDB) / Node.js (fake-indexeddb for tests) |
| Build | ESM + CJS dual output via tsup |
| Storage | Dexie.js (IndexedDB wrapper) |
| Hashing | Web Crypto API — SHA-256 |

### Source Structure

```
src/
├── index.ts                  Public exports
├── types.ts                  All public type definitions
├── errors.ts                 Discriminated union error types
├── event-log.ts              Factory: createEventLog()
├── hash-chain/
│   ├── hash.ts               SHA-256 via Web Crypto API
│   └── chain.ts              Hash chain linking and verification
├── storage/
│   ├── database.ts           Dexie.js IndexedDB schema
│   ├── event-writer.ts       Append-only event writing
│   ├── budget.ts             Storage usage tracking
│   ├── pressure.ts           Storage pressure levels
│   └── compaction.ts         Snapshot-based compaction
├── queries/
│   └── query-engine.ts       Cursor-based pagination queries
├── integrity/
│   └── verifier.ts           Hash chain verification
├── snapshots/
│   ├── snapshot-manager.ts   Snapshot creation + auto-snapshot
│   └── state-reconstructor.ts  Temporal state reconstruction
├── archive/
│   ├── format.ts             .rblogs binary format
│   ├── exporter.ts           Export to compressed archive
│   └── importer.ts           Import and deduplicate
└── diff/
    ├── types.ts              AST diff types
    ├── diff-storage.ts       Diff-aware event writing
    └── diff-reconstructor.ts Source reconstruction from diffs
```

### Stats

| Metric | Value |
|--------|-------|
| Public types | 25 |
| EventLog methods | 11 |
| Error codes | 7 |
| Event types | 11 |
| Exported functions | 12 |

---

## §2 EventLog Interface

> Source: [src/types.ts](../src/types.ts), [src/event-log.ts](../src/event-log.ts)

The primary API surface. Created via `createEventLog(config?)`.

| Method | Signature | Description |
|--------|-----------|-------------|
| `writeEvent` | `(event: Omit<Event, 'id' \| 'hash' \| 'previousHash' \| 'sequenceNumber'>) → Promise<Result<Event>>` | Append an event to the log with hash chain linking |
| `queryBySpace` | `(spaceId: string, options?: QueryOptions) → Promise<Result<PaginatedResult<Event>>>` | Query events by space ID with cursor pagination |
| `queryByType` | `(type: EventType, options?: QueryOptions) → Promise<Result<PaginatedResult<Event>>>` | Query events by type with cursor pagination |
| `queryByTime` | `(from: string, to: string, options?: QueryOptions) → Promise<Result<PaginatedResult<Event>>>` | Query events within a time range (from inclusive, to exclusive) |
| `reconstructState` | `(spaceId: string, atTimestamp?: string) → Promise<Result<unknown>>` | Reconstruct space state at a timestamp using snapshots + replay |
| `verifyIntegrity` | `(spaceId?: string) → Promise<Result<IntegrityReport>>` | Verify hash chain integrity for a space or entire database |
| `createSnapshot` | `(spaceId: string) → Promise<Result<Snapshot>>` | Create a snapshot of current state for acceleration |
| `compact` | `(spaceId: string) → Promise<Result<CompactionReport>>` | Create a snapshot at the latest event to accelerate future reconstruction |
| `getStorageUsage` | `() → Promise<Result<StorageReport>>` | Get storage utilization statistics |
| `exportArchive` | `(spaceId: string, beforeDate: string) → Promise<Result<Uint8Array>>` | Export events older than a date to a `.rblogs` archive |
| `importArchive` | `(archive: Uint8Array) → Promise<Result<ImportReport>>` | Import events from a `.rblogs` archive, deduplicating by ID |

All methods return `Result<T, EventLogError>` — a discriminated union with `{ ok: true, value: T }` on success and `{ ok: false, error: EventLogError }` on failure. No methods throw.

---

## §3 Event Schema

> Source: [src/types.ts](../src/types.ts)

### Event

| Field | Type | Description |
|-------|------|-------------|
| `id` | `string` | UUID v4, generated by the library (injectable via `idGenerator` config) |
| `type` | `EventType` | One of 11 event categories |
| `spaceId` | `string` | The space this event belongs to |
| `timestamp` | `string` | ISO 8601 timestamp — caller-provided, never generated internally |
| `sequenceNumber` | `number` | Monotonically increasing per space |
| `hash` | `string` | SHA-256 hex of this event's content |
| `previousHash` | `string \| null` | SHA-256 hex of predecessor, or `null` for genesis |
| `version` | `number` | Schema version for forward compatibility |
| `payload` | `Readonly<Record<string, unknown>>` | Arbitrary caller-defined data |

### EventType (11 variants)

```
space_created · space_evolved · space_forked · space_deleted
state_changed · action_invoked
intent_submitted · intent_queued · intent_resolved
user_feedback · system_event
```

---

## §4 Query System

> Source: [src/queries/query-engine.ts](../src/queries/query-engine.ts)

### QueryOptions

| Field | Type | Default | Description |
|-------|------|---------|-------------|
| `limit` | `number` | 100 | Max items per page. Clamped to [1, 1000]. |
| `cursor` | `string` | — | Opaque base64 cursor for next page |
| `order` | `'asc' \| 'desc'` | `'asc'` | Sort by sequence number |

### PaginatedResult\<T\>

| Field | Type | Description |
|-------|------|-------------|
| `items` | `readonly T[]` | Items in this page |
| `nextCursor` | `string \| undefined` | Cursor for the next page. Undefined = no more pages. |
| `total` | `number` | Total matching count across all pages |

### Cursor Encoding

Cursors are opaque base64-encoded JSON: `{ seq: number, id: string }`. Callers must not decode or construct cursors — pass them directly from `nextCursor` to the next query's `cursor` option.

### Pagination Rules

- `limit` is clamped: values ≤ 0 become 1, values > 1000 become 1000
- `queryByTime` range: `from` is inclusive, `to` is exclusive
- Invalid ISO 8601 timestamps in `queryByTime` return `INVALID_QUERY` error
- Invalid cursor format returns `INVALID_QUERY` error

---

## §5 Hash Chain & Integrity

> Source: [src/hash-chain/hash.ts](../src/hash-chain/hash.ts), [src/hash-chain/chain.ts](../src/hash-chain/chain.ts), [src/integrity/verifier.ts](../src/integrity/verifier.ts)

### Deterministic Serialization

Events are serialized for hashing via deterministic JSON: keys sorted alphabetically at all nesting levels, then `JSON.stringify`. This ensures identical inputs always produce identical hashes regardless of object key insertion order.

### Hash Computation

All `Event` fields except `hash` itself are included in the hash input: `id`, `type`, `spaceId`, `timestamp`, `sequenceNumber`, `previousHash`, `version`, `payload`. The hash is computed as `SHA-256(deterministicSerialize(eventWithoutHash))` → 64-char hex string.

### Chain Rules

- **Genesis event** (first per space): `previousHash: null`
- **Subsequent events**: `previousHash: predecessor.hash`
- Chain is verified on every write — writes fail if the chain is broken

### IntegrityReport

| Field | Type | Description |
|-------|------|-------------|
| `valid` | `boolean` | Whether the entire chain is intact |
| `totalEvents` | `number` | Events in scope |
| `checkedEvents` | `number` | Events verified |
| `firstBrokenLink` | `{ eventId, expected, actual } \| undefined` | First detected tampering |
| `duration` | `number` | Verification duration in ms |

---

## §6 Snapshots & State Reconstruction

> Source: [src/snapshots/snapshot-manager.ts](../src/snapshots/snapshot-manager.ts), [src/snapshots/state-reconstructor.ts](../src/snapshots/state-reconstructor.ts)

### Snapshot

A checkpoint of reconstructed state at a specific point in the event chain.

| Field | Type | Description |
|-------|------|-------------|
| `id` | `string` | UUID, generated via `idGenerator` |
| `spaceId` | `string` | The space |
| `eventSequenceNumber` | `number` | Last event included |
| `timestamp` | `string` | Timestamp of the last included event |
| `state` | `unknown` | Reconstructed state |
| `hash` | `string` | SHA-256 of the serialized state |

### State Reducer

```typescript
type StateReducer = (state: unknown, event: Event) => unknown;
```

Folds events into state. Default: last-write-wins (returns `event.payload`). Provide a custom reducer via `EventLogConfig.stateReducer` for domain-specific state.

### Auto-Snapshot

After every successful `writeEvent`, the library checks if `snapshotInterval` events have accumulated since the last snapshot. If so, a snapshot is created automatically.

### Reconstruction Algorithm

1. Find the nearest snapshot BEFORE `atTimestamp` (or latest if no timestamp)
2. Load snapshot state
3. Query events AFTER snapshot up to `atTimestamp`
4. Apply events sequentially using `stateReducer`
5. Return reconstructed state

If no snapshot exists, replay starts from genesis.

---

## §7 Storage System

> Source: [src/storage/budget.ts](../src/storage/budget.ts), [src/storage/pressure.ts](../src/storage/pressure.ts), [src/storage/compaction.ts](../src/storage/compaction.ts)

### StorageReport

| Field | Type | Description |
|-------|------|-------------|
| `totalEvents` | `number` | Total events in database |
| `totalSnapshots` | `number` | Total snapshots in database |
| `estimatedBytes` | `number` | Estimated storage in bytes |
| `oldestEvent` | `string \| undefined` | ISO 8601 of oldest event |
| `newestEvent` | `string \| undefined` | ISO 8601 of newest event |
| `spaces` | `readonly SpaceStorageInfo[]` | Per-space breakdown |

### SpaceStorageInfo

| Field | Type |
|-------|------|
| `spaceId` | `string` |
| `eventCount` | `number` |
| `estimatedBytes` | `number` |

### Storage Pressure Levels

`getStoragePressure(report: StorageReport, availableBytes: number): StoragePressureReport`

A pure function (no database access needed).

| Level | Threshold | Recommendation |
|-------|-----------|----------------|
| `NORMAL` | < 50% | No action needed |
| `COMPACT` | 50–70% | Background compaction |
| `EXPORT_PROMPT` | 70–80% | Prompt user to export old events |
| `AGGRESSIVE` | 80–90% | Auto-compact, aggressive snapshots, warn on write |
| `BLOCKED` | > 90% | Block new space creation until user frees space |

### CompactionReport

| Field | Type | Description |
|-------|------|-------------|
| `spaceId` | `string` | Space compacted |
| `eventsCompacted` | `number` | Events covered by new snapshot |
| `estimatedBytesSaved` | `number` | Estimated savings |
| `snapshotId` | `string` | ID of the created snapshot |

---

## §8 Archive Format

> Source: [src/archive/format.ts](../src/archive/format.ts), [src/archive/exporter.ts](../src/archive/exporter.ts), [src/archive/importer.ts](../src/archive/importer.ts)

### `.rblogs` Binary Layout

```
Offset  Size   Content
──────  ─────  ───────────────────────────────
0       5      Magic bytes: 0x52 0x42 0x4C 0x4F 0x47 ("RBLOG")
5       1      Format version (uint8) — currently 0x01
6       4      Event count (uint32, big-endian)
10      N      Deflate-compressed JSON body (Event[])
10+N    64     SHA-256 hex hash of uncompressed JSON body
```

### Export Flow

1. Query events for space older than `beforeDate`
2. Verify hash chain integrity of selected events
3. Serialize events to JSON array
4. Compress with `CompressionStream` (deflate)
5. Prepend 10-byte header, append 64-byte footer

### Import Flow

1. Validate header: magic bytes, version, size
2. Extract compressed body and footer hash
3. Decompress body
4. Verify SHA-256 of decompressed content matches footer
5. Parse events from JSON
6. Validate each event's structure
7. Skip duplicates (by `id` — already in database)
8. Verify hash chain of imported events
9. Write non-duplicate events

### ImportReport

| Field | Type | Description |
|-------|------|-------------|
| `importedEvents` | `number` | Events successfully imported |
| `skippedDuplicates` | `number` | Events already in database |
| `errors` | `readonly ImportError[]` | Per-event errors |

### Round-Trip Guarantee

Export → import → export produces byte-identical archives. Verified by determinism tests.

---

## §9 AST Diff Storage

> Source: [src/diff/types.ts](../src/diff/types.ts), [src/diff/diff-storage.ts](../src/diff/diff-storage.ts), [src/diff/diff-reconstructor.ts](../src/diff/diff-reconstructor.ts)

### AstDiffOperation

| Field | Type | Description |
|-------|------|-------------|
| `path` | `string` | Dot-separated path in the AST |
| `operation` | `DiffOperationType` | `'add' \| 'modify' \| 'remove'` |
| `before` | `unknown \| undefined` | Value before change (required for modify, remove) |
| `after` | `unknown \| undefined` | Value after change (required for add, modify) |

### Structured Payloads

| Type | Event Type | Fields |
|------|-----------|--------|
| `DiffPayload` | `space_evolved` | `astDiff`, `scopeMetadata`, `sourceHash` |
| `SpaceCreatedPayload` | `space_created` | `source`, `sourceHash`, `compiledWasmHash` |
| `SpaceForkedPayload` | `space_forked` | `sourceSpaceId`, `forkTimestamp` |

### ScopeMetadata

| Field | Type |
|-------|------|
| `changedNodes` | `number` |
| `totalNodes` | `number` |
| `affectedFunctions` | `readonly string[]` |

### Diff Helper Functions

| Function | Signature | Description |
|----------|-----------|-------------|
| `writeDiffEvent` | `(db, spaceId, timestamp, astDiff, scopeMetadata, sourceHash) → Promise<Result<Event>>` | Write a `space_evolved` event with structured diff payload |
| `writeGenesisEvent` | `(db, spaceId, timestamp, source, sourceHash, compiledWasmHash) → Promise<Result<Event>>` | Write a `space_created` genesis event |
| `reconstructSource` | `(db, spaceId, atTimestamp?) → Promise<Result<ReconstructedSource>>` | Reconstruct source from genesis + diff chain |

### ReconstructedSource

| Field | Type | Description |
|-------|------|-------------|
| `source` | `string` | Reconstructed source text |
| `sourceHash` | `string` | SHA-256 of the source |
| `diffsApplied` | `number` | Number of diffs applied |
| `lastSequenceNumber` | `number` | Last event sequence used |

### Storage Savings

| Event Type | Typical Size |
|-----------|-------------|
| `space_created` (full source) | 5–50 KB |
| `space_evolved` (diff only) | 0.5–5 KB |
| Snapshot (full source) | 5–50 KB |

A space with 1000 evolve events stores ~5 MB of diffs vs ~50 MB of full source snapshots.

---

## §10 Error Types

> Source: [src/errors.ts](../src/errors.ts)

All errors use a discriminated union on the `code` field.

### EventLogErrorCode (7 variants)

| Code | Fields | Meaning |
|------|--------|---------|
| `INTEGRITY_VIOLATION` | `eventId`, `expected`, `actual` | Hash chain link broken |
| `STORAGE_FULL` | `usedBytes`, `maxBytes` | Storage quota exceeded |
| `INVALID_QUERY` | `field`, `reason` | Malformed query parameters |
| `INVALID_EVENT` | `field`, `reason` | Invalid event data |
| `SNAPSHOT_FAILED` | `spaceId`, `reason` | Snapshot creation failed |
| `IMPORT_FAILED` | `reason`, `eventId?` | Archive import failed |
| `DATABASE_ERROR` | `operation`, `reason` | IndexedDB operation failed |

### Error Factory Functions

```typescript
integrityViolation(eventId: string, expected: string, actual: string): EventLogError
storageFull(usedBytes: number, maxBytes: number): EventLogError
invalidQuery(field: string, reason: string): EventLogError
invalidEvent(field: string, reason: string): EventLogError
snapshotFailed(spaceId: string, reason: string): EventLogError
importFailed(reason: string, eventId?: string): EventLogError
databaseError(operation: string, reason: string): EventLogError
```

### Result\<T, E\>

```typescript
type Result<T, E = EventLogError> =
  | { readonly ok: true; readonly value: T }
  | { readonly ok: false; readonly error: E };
```

---

## §11 Configuration

> Source: [src/types.ts](../src/types.ts)

### EventLogConfig

All fields are optional with sensible defaults.

| Field | Type | Default | Description |
|-------|------|---------|-------------|
| `databaseName` | `string` | `"event-log"` | IndexedDB database name |
| `schemaVersion` | `number` | `1` | Database schema version |
| `maxEventsPerQuery` | `number` | `1000` | Maximum events per query |
| `snapshotInterval` | `number` | `100` | Auto-snapshot every N events per space |
| `hashAlgorithm` | `'SHA-256'` | `'SHA-256'` | Hash algorithm |
| `stateReducer` | `(state, event) => unknown` | Last-write-wins | Custom state reconstruction logic |
| `idGenerator` | `() => string` | `crypto.randomUUID()` | ID generator for events and snapshots. Inject a deterministic generator for reproducible outputs. |

---

## §12 Guarantees

| Guarantee | Description |
|-----------|-------------|
| **Append-only** | Events are never modified or deleted after write |
| **Hash chain integrity** | Every event links to its predecessor via SHA-256 |
| **Monotonic sequences** | Sequence numbers are strictly increasing per space |
| **Genesis invariant** | First event per space has `previousHash: null` |
| **Deterministic hashing** | Same event content → identical hash, always |
| **Round-trip archives** | Export → import → export produces byte-identical archives |
| **Caller-injected time** | Timestamps are provided by the caller, never generated internally |
| **Injectable randomness** | ID generation is configurable via `idGenerator` for deterministic replay |

---

## §13 Deferred to Future

| Item | Phase | Notes |
|------|-------|-------|
| Multi-device sync | 1+ | Local-only in Phase 0 |
| SQLite / RocksDB backend | 1+ | Same interface, different storage |
| Event subscription / streaming | 1+ | Currently pull-based queries only |
| Alternative hash algorithms | 1+ | SHA-256 only in Phase 0 |
| Embedded KV backend | 3+ | For constrained hardware |

---

*Last verified: 14 February 2026 against source code.*
